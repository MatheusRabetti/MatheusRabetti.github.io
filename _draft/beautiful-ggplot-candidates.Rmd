---
title: "Untitled"
author: "Matheus Rabetti"
date: "November 11, 2016"
output: html_document
---

```{r setup, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(data.table)
library(magrittr)
```

```{r first-look}
tf <- tempfile(); td <- tempdir()
url = 'http://agencia.tse.jus.br/estatistica/sead/odsele/consulta_cand/consulta_cand_2016.zip'
download.file(url, destfile = tf)
unzip(tf, exdir = td)
```


The *system* R function calls a bash command. Let's use them to have a look on the files.

```{r bash-commands}
# Filesize
system(sprintf('cd %s; wc -c consulta_cand_2016_SP.txt', td))
# Head
system(sprintf('cd %s ; 
       head -n 3 consulta_cand_2016_SP.txt | iconv -f iso-8859-1 -t UTF-8', td))
```

The, likely, biggest file have only 46 Mb.
The file does not have a header, the *NULL* entries are **"#NULO#"** and the separator is **";"**. The year states files come with a README pdf. There you can see the header. 

The next step is do it in a loop so I can have candidates files candidates file for the 2004 year until 2016. As the files comes separeted by states, we have to bind them into one. It can be done in R, but it's easier and faster in **bash** using *cat*.

Fortunately I found a Github repository that have mapped the header - [Github silvadenisson](https://github.com/silvadenisson/electionsBR/blob/master/R/candidate_local.R). I saved the naming part of the file in my Github. Know, let's use it.


```{r loop-read}
candidates_data <- list()

for(ano in seq(2004, 2016, 4)){
  cat('Downloading year', ano, '\n')

  # Download and save in a temporary folder
  sprintf('http://agencia.tse.jus.br/estatistica/sead/odsele/consulta_cand/consulta_cand_%s.zip',ano) %>% 
    download.file(destfile = tf)
  unzip(tf, exdir = td)

  cat('Binding and reading the files ...\n')
  # Binding
  system(sprintf('cd %s; cat consulta*%s*.txt >> all-%s.txt', td, ano, ano))
  # Reading
  candidates_data[[as.character(ano)]] <- 
    fread(sprintf('%s/all-%s.txt',td,ano), 
          header = F, sep = ";", 
          stringsAsFactors = F, 
          encoding = "Latin-1")
  
  header = dget('https://raw.githubusercontent.com/MatheusRabetti/matheusrabetti.github.io/master/assets/posts/candidates-beautiful-plot/header.R')
  
  names(candidates_data[[as.character(ano)]]) <- header
  
}


candidates_data <- data.table::rbindlist(candidates_data, use.names = T, fill = T)

```

I'll select the variables listed below to continue my analysis:

  - **ANO_ELEICAO:** Election year
  - **DESCRICAO_CARGO:** Description of the position that the candidate runs for.
  - **DESCRICAO_OCUPACAO:** Candidate's occupation description.
  - **CODIGO_SEXO:** Candidate's sex code.
  - **DESCRICAO_SEXO:** Candidate's sex description.


```{r select}

candidates_data %<>% 
  select(ANO_ELEICAO, DESCRICAO_CARGO, DESCRICAO_OCUPACAO, 
         CODIGO_SEXO, DESCRICAO_SEXO)
```



